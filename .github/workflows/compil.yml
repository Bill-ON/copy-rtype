name: Compile on UNIX

on: [push, pull_request]

env:
    CMAKE_CXX_COMPILER: /usr/bin/g++
    CMAKE_C_COMPILER: /usr/bin/gcc
    CMAKE_TOOLCHAIN_FILE: ${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake
    CMAKE_MAKE_PROGRAM: /usr/bin/make

jobs:
  linux:
    name: Linux-x86
    runs-on: ubuntu-latest
    

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0
          
      - name: install basics
        run: sudo apt install build-essential

      - name: Create BUILD folder
        working-directory: ${{github.workspace}}/server
        run: mkdir build
      
      - name: install NINJA
        run: python -m pip install ninja
        
      - name: Configure Server
        working-directory: ${{github.workspace}}/server
        run: cmake -S . -B ./build -DCMAKE_CXX_COMPILER=/usr/bin/g++ -DCMAKE_C_COMPILER=/usr/bin/gcc -DCMAKE_TOOLCHAIN_FILE=${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake -DCMAKE_MAKE_PROGRAM=/usr/bin/make
        continue-on-error: true
        
      - name: delete Cache
        working-directory: ${{github.workspace}}/server/build
        run: rm -rf CMakeCache.txt
        
      - name: reload Server cache
        working-directory: ${{github.workspace}}/server
        run: cmake -S . -B ./build -DCMAKE_CXX_COMPILER=/usr/bin/g++ -DCMAKE_C_COMPILER=/usr/bin/gcc -DCMAKE_TOOLCHAIN_FILE=${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake -DCMAKE_MAKE_PROGRAM=/usr/bin/make
        continue-on-error: true
        
      - name: check files
        working-directory: ${{github.workspace}}/server
        run: ls
        
      - name: check files in build
        working-directory: ${{github.workspace}}/server/build
        run: ls
        
      - name: Build Server
        working-directory: ${{github.workspace}}/server
        run: cmake --build ./build
